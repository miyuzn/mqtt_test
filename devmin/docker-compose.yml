version: "3.9"

x-data-root: &data_root ./data

services:
  parser:
    build:
      context: ..
      dockerfile: devmin/parser_store.Dockerfile
    container_name: devmin-parser
    restart: unless-stopped
    environment:
      # 原始帧和解析后的帧都在容器内部通过 localhost 传输
      RAW_BROKER_HOST: localhost
      RAW_BROKER_PORT: 1883
      RAW_TOPIC: etx/v1/raw/#
      RAW_QOS: 1
      PARSED_BROKER_HOST: localhost
      PARSED_BROKER_PORT: 9001
      PARSED_TRANSPORT: websockets
      PARSED_WS_PATH: /mqtt
      PARSED_TOPIC_PREFIX: etx/v1/parsed
      PARSED_QOS: 1
      BROKER_HOST: localhost
      BROKER_PORT: 1883
      MQTT_BROKER_HOST: localhost
      MQTT_SUB_TOPIC: etx/v1/raw/#
      SINK_FLUSH_EVERY_ROWS: 1
      SINK_ROOT_DIR: /workspace/data/mqtt_store
    volumes:
      - ../backend:/workspace/app
      - ../server:/workspace/server
      - ../config.ini:/workspace/config.ini:ro
      - ./data/mqtt_store:/workspace/data/mqtt_store
      - ./data/mosquitto:/mosquitto
    ports:
      - "127.0.0.1:${DEVMIN_MQTT_PORT:-1883}:1883"
      - "127.0.0.1:${DEVMIN_MQTT_WS_PORT:-9001}:9001"

  sink:
    build:
      context: ..
      dockerfile: devmin/sink.Dockerfile
    container_name: devmin-sink
    depends_on:
      - parser
    environment:
      MQTT_BROKER_HOST: parser
      MQTT_BROKER_PORT: 1883
      MQTT_SUB_TOPIC: etx/v1/raw/#
      SINK_FLUSH_EVERY_ROWS: 1
      SINK_ROOT_DIR: /workspace/data/mqtt_store
    volumes:
      - ../backend:/workspace/app
      - ../config.ini:/workspace/config.ini:ro
      - ./data/mqtt_store:/workspace/data/mqtt_store

  web:
    build:
      context: ..
      dockerfile: devmin/webstack.Dockerfile
    container_name: devmin-web
    depends_on:
      - parser
    environment:
      BROKER_FORWARD_HOST: parser
      BROKER_FORWARD_PORT: 1883
      BROKER_LOCAL_PORT: 1883
      BROKER_FORWARD_ENABLED: 1
      BROKER_HOST: parser
      BROKER_PORT: 1883
      MQTT_SUB_TOPIC: etx/v1/parsed/#
      BRIDGE_PORT: ${DEVMIN_BRIDGE_PORT:-5001}
      BRIDGE_API_BASE_URL: http://localhost:${DEVMIN_BRIDGE_PORT:-5001}
      CONFIG_CONSOLE_PORT: ${DEVMIN_CONSOLE_PORT:-5002}
      CONFIG_CONSOLE_ENABLED: 1
      CONFIG_BROKER_HOST: localhost
      CONFIG_BROKER_PORT: 1883
    volumes:
      - ../server:/workspace/server
      - ../web:/workspace/webapp
      - ../backend:/workspace/app
      - ../license:/workspace/license
    ports:
      - "127.0.0.1:${DEVMIN_BRIDGE_PORT:-5001}:5001"
      - "127.0.0.1:${DEVMIN_WEB_PORT:-5000}:5000"
      - "127.0.0.1:${DEVMIN_CONSOLE_PORT:-5002}:5002"
