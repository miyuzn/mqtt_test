services:
  broker:
    image: eclipse-mosquitto:2
    container_name: mqtt-broker
    restart: unless-stopped
    ports:
      - "8883:8883"   # Secure MQTT (TLS)
    volumes:
      - ./broker/config:/mosquitto/config
      - ./broker/data:/mosquitto/data
      - ./broker/log:/mosquitto/log
      - ./certs:/mosquitto/certs:ro
    command: ["mosquitto", "-c", "/mosquitto/config/mosquitto.secure.conf"]

  backend:
    build: ./backend
    container_name: mqtt-backend
    depends_on:
      - broker
    environment:
      # --- Parser Configuration ---
      - RAW_BROKER_HOST=broker
      - RAW_BROKER_PORT=1883
      - RAW_TOPIC=etx/v1/raw/#
      - RAW_QOS=1
      - PARSED_BROKER_HOST=broker
      - PARSED_BROKER_PORT=1883
      - PARSED_TRANSPORT=tcp
      - PARSED_TOPIC_PREFIX=etx/v1/parsed
      - PARSED_QOS=1
      # --- Bridge Configuration ---
      - BROKER_HOST=broker
      - BROKER_PORT=1883
      - MQTT_SUB_TOPIC=etx/v1/parsed/#
      - MQTT_QOS=1
      - CLIENT_ID=mqtt-bridge
      - BRIDGE_PORT=5001
    volumes:
      - ./backend:/app
      - ./server:/server
    # 使用新建的组合启动脚本
    command: ["sh", "backend_entrypoint.sh"]
    restart: unless-stopped

  sink:
    build: ./backend
    container_name: mqtt-sink
    depends_on:
      - broker
    environment:
      - BROKER_HOST=broker
      - BROKER_PORT=1883
      - SUB_TOPICS=etx/v1/parsed/#,demo/#,secure/#
      - PUB_TOPIC=demo/hello
      - USERNAME=
      - PASSWORD=
    volumes:
      - ./backend:/app
    command: ["python", "sink.py"]
    # Sink 默认为 unless-stopped，如果希望仅手动启动，可以移除 restart 策略或改为 no
    restart: unless-stopped

  web:
    build: ./web
    container_name: mqtt-web
    depends_on:
      - backend
    environment:
      # 指向合并后的 backend 容器
      - BRIDGE_API_BASE_URL=http://backend:5001
      - BRIDGE_CONNECT_TIMEOUT=5
      - BRIDGE_READ_TIMEOUT=30
      - BROKER_HOST=broker
      - BROKER_PORT=1883
      - WEB_SSL_ENABLED=1
      - WEB_SSL_CERT=/certs/web.crt
      - WEB_SSL_KEY=/certs/web.key
    volumes:
      - ./web:/app
      - ./license:/license
      - ./certs:/certs:ro
      - ./ota_dist:/ota:ro  # OTA firmware directory (Read-Only)
    ports:
      - "443:5000"              # HTTPS (public)
      - "127.0.0.1:8443:5000"   # Loopback HTTPS (debug)
      - "5002:5002"             # Config console (LAN)
    restart: unless-stopped